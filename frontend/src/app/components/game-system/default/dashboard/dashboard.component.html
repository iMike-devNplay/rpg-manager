<div class="dashboard-container" *ngIf="currentUser">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-left">
      <h1>🎲 RPG Manager</h1>
      <div class="user-character-info">
        <span class="user-info">
          {{ currentUser.username }} 
          <span class="mode-badge" [class]="'mode-' + currentUser.mode">
            {{ getModeLabel(currentUser.mode) }}
          </span>
        </span>
        <div class="character-info" *ngIf="currentCharacter">
          <div class="character-details">
            <span class="character-name" (click)="navigateToCharacterPage()">
                  🧙‍♂️ {{ currentCharacter.name }}
                </span>
            <span class="character-system">
              {{ getGameSystemLabel(currentCharacter.gameSystem) }}
            </span>
          </div>
        </div>
        <!-- character selector is a separate page; dashboard only provides navigation -->
        <button class="btn-character" *ngIf="!currentCharacter" (click)="navigateToCharacterPage()">
          ➕ Créer un personnage
        </button>
      </div>
    </div>
    
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="navigateToCharacterPage()" *ngIf="currentCharacter">
        👥 Personnages
      </button>
      <button class="btn btn-secondary" (click)="exportData()">
        📤 Exporter
      </button>
      <button class="btn btn-secondary" (click)="importData()">
        📥 Importer
      </button>
      <button class="btn btn-secondary" (click)="switchMode()" *ngIf="canSwitchMode()">
        🔄 {{ getOtherModeLabel() }}
      </button>
      <button class="btn btn-danger" (click)="logout()">
        🚪 Déconnexion
      </button>
    </div>
  </header>

  <!-- Navigation pour Maître de jeu -->
  <nav class="gm-navigation" *ngIf="isGameMaster()">
    <button 
      class="nav-btn" 
      [class.active]="currentView === 'dashboard'"
      (click)="setView('dashboard')"
    >
      📊 Dashboard
    </button>
    <button 
      class="nav-btn" 
      [class.active]="currentView === 'combat'"
      (click)="setView('combat')"
    >
      ⚔️ Combat
    </button>
    <button 
      class="nav-btn" 
      [class.active]="currentView === 'players'"
      (click)="setView('players')"
    >
      👥 Joueurs
    </button>
  </nav>

  <!-- Dashboard principal avec système d'onglets -->
  <main class="dashboard-main" *ngIf="currentView === 'dashboard' && currentCharacter">
    <!-- Barre d'onglets -->
    <app-tab-bar
      [tabs]="dashboardTabs"
      [activeTabId]="activeTabId"
      [canAddTab]="canAddTab"
      (tabSelected)="onTabSelected($event)"
      (tabAdd)="onTabAdd()"
      (tabEdit)="onTabEdit($event)"
      (tabDelete)="onTabDelete($event)"
      (tabDropped)="onTabDropped($event)"
      (elementAdd)="addItem()">
    </app-tab-bar>

    <!-- Contenu de l'onglet actif -->
    <div class="tab-content" *ngIf="activeTabId">
      <!-- Affichage multi-colonnes dynamique -->
      <div class="columns-container" *ngIf="getActiveTabItems().length > 0">
        <div 
          *ngFor="let columnIndex of getColumns()"
          class="column"
          [attr.data-column]="columnIndex"
          [attr.data-column-width]="getColumnWidth(columnIndex)"
          [class.drag-over]="draggedOverColumn === columnIndex"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDropColumn($event, columnIndex)"
        >
          <!-- Header de la colonne avec bouton de largeur -->
          <div class="column-header">
            <button 
              class="column-width-btn" 
              (click)="toggleColumnWidth(columnIndex)"
              [title]="'Largeur: ' + getColumnWidth(columnIndex) + ' colonne(s)'"
            >
              <span class="width-indicator">{{ getColumnWidth(columnIndex) }}x</span>
            </button>
          </div>
          
          <app-element-display 
            *ngFor="let item of getItemsByColumn(columnIndex)" 
            [item]="item"
            [showQuickModification]="true"
            (itemUpdated)="onItemUpdated($event)"
            (itemDeleted)="onItemDeleted($event)"
            (itemEdit)="onItemEdit($event)"
            (itemDragStart)="onItemDragStart($event)"
            (itemDragEnd)="onItemDragEnd()"
            (itemDroppedOn)="onItemDroppedOn($event)">
          </app-element-display>
        </div>
        
        <!-- Zone de drop pour créer une nouvelle colonne -->
        <div 
          class="column column-new"
          [class.drag-over]="draggedOverColumn === getColumnCount()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDropColumn($event, getColumnCount())"
          *ngIf="draggedItem"
        >
          <div class="new-column-placeholder">
            <span class="placeholder-icon">➕</span>
            <span class="placeholder-text">Nouvelle colonne</span>
          </div>
        </div>
      </div>

      <!-- Zone vide -->
      <div 
        class="empty-tab"
        *ngIf="getActiveTabItems().length === 0"
        (dragover)="onDragOver($event)"
        (drop)="onDropColumn($event, 0)"
      >
        <div class="empty-tab-content">
          <span class="empty-icon">📋</span>
          <h3>Aucun élément dans cet onglet</h3>
          <p>Cliquez sur le bouton ➕ dans la barre d'onglets pour ajouter un élément</p>
          <p class="drag-hint" *ngIf="draggedItem">Ou déposez un élément ici</p>
        </div>
      </div>
    </div>
  </main>

  <!-- Vue Combat (pour Maître de jeu) -->
  <main *ngIf="currentView === 'combat' && isGameMaster()">
    <app-combat-management></app-combat-management>
  </main>

  <!-- Vue Joueurs (pour Maître de jeu) -->
  <main *ngIf="currentView === 'players' && isGameMaster()">
    <app-players-management></app-players-management>
  </main>
</div>

<!-- Modal pour la gestion des onglets -->
<app-tab-modal
  [isOpen]="showTabModal"
  [editingTab]="editingTab"
  (save)="onTabSave($event)"
  (close)="closeTabModal()">
</app-tab-modal>

<!-- Modal pour ajouter/éditer un élément -->
<app-element-creation-orchestrator
  [isOpen]="showCreateElementModal"
  [gameSystem]="getGameSystemForNewElement()"
  [zone]="currentZone"
  [editingElement]="getEditingElementForNewSystem()"
  [editingDataItem]="editingItem"
  (close)="closeCreateElementModal()"
  (elementSaved)="onElementCreated($event)">
</app-element-creation-orchestrator>